version: "3"

services:
  postgresdb:
      # Для использования версии 15 нужно разобрать с правами на public schema
      image: postgres
      restart: always
      environment:
        - POSTGRES_PASSWORD=password
      volumes:
        - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
        - postgres_data:/var/lib/postgresql/data/

  web:
    image: anra/reg_vcs
    environment:
      # Mode
      - MODE_DEBUG=${MODE_DEBUG}
      - MODE_ALLOWED_HOSTS=${MODE_ALLOWED_HOSTS}
      # Database
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      # Telegram
      - BOT_API_TOKEN=${BOT_API_TOKEN}
      - BOT_NAME=${BOT_NAME}
      # Email
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - EMAIL_PORT=${EMAIL_PORT}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS}
    volumes:
      - static_volume:/usr/src/app/static
      - media_volume:/usr/src/app/media
    depends_on:
      - postgresdb

  nginx:
    image: nginx
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - static_volume:/usr/src/app/static
      - media_volume:/usr/src/app/media
    depends_on:
      - web
    ports:
    - 80:80

volumes:
  postgres_data:
  static_volume:
  media_volume: